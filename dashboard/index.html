<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Oman Agri-Tech Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #020617;
        color: #f1f5f9;
        font-family: "Inter", ui-sans-serif, system-ui;
      }
      .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .live-feed {
        height: 400px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        border-radius: 8px;
      }
      .scan-line {
        width: 100%;
        height: 2px;
        background: rgba(34, 197, 94, 0.5);
        position: absolute;
        top: 0;
        animation: scan 2s linear infinite;
        display: none;
      }
      @keyframes scan {
        from {
          top: 0;
        }
        to {
          top: 100%;
        }
      }
      .completion-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 100;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body class="p-8">
    <div
      id="finish-overlay"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      "
    >
      <h1
        style="
          color: #22c55e;
          font-size: 5rem;
          font-weight: 900;
          margin-bottom: 1rem;
        "
      >
        MISSION COMPLETE
      </h1>
      <p style="color: #94a3b8; font-size: 1.5rem">
        All agricultural sectors have been verified.
      </p>
      <button
        onclick="window.location.reload()"
        style="
          margin-top: 2rem;
          padding: 1rem 3rem;
          background: #22c55e;
          color: white;
          border-radius: 99px;
          font-weight: bold;
          cursor: pointer;
        "
      >
        RESTART SYSTEM
      </button>
    </div>

    <div class="max-w-7xl mx-auto">
      <header
        class="flex justify-between items-end mb-8 border-b border-slate-800 pb-6"
      >
        <div>
          <h1 class="text-4xl font-black tracking-tighter text-white">
            AGRI-TECH <span class="text-green-500 italic">OMAN</span>
          </h1>
          <p class="text-slate-400 font-mono text-sm tracking-widest uppercase">
            Hybrid Autonomous Inspection Network
          </p>
        </div>
        <div class="flex gap-8 text-right font-mono">
          <div>
            <p class="text-xs text-slate-500">OPERATIONAL MODE</p>
            <p class="text-green-400 font-bold">AUTONOMOUS</p>
          </div>
          <div>
            <p class="text-xs text-slate-500">NETWORK</p>
            <p class="text-blue-400 font-bold">ENCRYPTED</p>
          </div>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div
          class="lg:col-span-2 glass p-6 rounded-2xl transition-all duration-500"
          id="drone-card"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span class="text-blue-500">üöÅ</span> AERIAL UNIT: DJI TELLO
            </h2>
            <span
              id="drone-tag"
              class="px-3 py-1 rounded text-xs font-bold bg-slate-700"
              >STANDBY</span
            >
          </div>
          <div class="live-feed">
            <div id="drone-scan" class="scan-line"></div>
            <img
              id="drone-img"
              src=""
              class="w-full h-full object-cover hidden"
            />
            <div id="drone-idle" class="text-slate-700 font-mono">
              WAITING FOR AERIAL UPLINK...
            </div>
          </div>
          <div class="mt-4 flex gap-6">
            <div class="glass p-3 rounded-xl flex-1">
              <p class="text-xs text-slate-500">TARGET CLASS</p>
              <p id="drone-class" class="text-lg font-bold">-</p>
            </div>
            <div class="glass p-3 rounded-xl flex-1">
              <p class="text-xs text-slate-500">CONFIDENCE</p>
              <p id="drone-conf" class="text-lg font-bold text-blue-400">-</p>
            </div>
          </div>
        </div>

        <div
          class="glass p-6 rounded-2xl opacity-40 transition-all duration-500"
          id="tank-card"
        >
          <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
            <span class="text-red-500">üöú</span> GROUND UNIT: G1 TANK
          </h2>
          <div class="live-feed !height-[250px]">
            <div id="tank-scan" class="scan-line"></div>
            <img
              id="tank-img"
              src=""
              class="w-full h-full object-cover hidden"
            />
            <div id="tank-idle" class="text-slate-700 font-mono text-xs">
              AWAITING DRONE COORDINATES...
            </div>
          </div>
          <div class="mt-4 space-y-4">
            <div class="flex justify-between border-b border-slate-700 pb-2">
              <span class="text-slate-500 text-sm">Status</span
              ><span id="tank-tag" class="font-bold text-sm text-red-400"
                >IDLE</span
              >
            </div>
            <div class="flex justify-between border-b border-slate-700 pb-2">
              <span class="text-slate-500 text-sm">Class</span
              ><span id="tank-class" class="font-bold text-sm">-</span>
            </div>
            <div class="flex justify-between border-b border-slate-700 pb-2">
              <span class="text-slate-500 text-sm">Confidence</span
              ><span id="tank-conf" class="font-bold text-sm">-</span>
            </div>
          </div>
        </div>
      </div>

      <div class="glass p-6 rounded-2xl">
        <h3
          class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4"
        >
          Centralized Mission Logs
        </h3>
        <table class="w-full text-left">
          <thead>
            <tr
              class="text-slate-500 text-xs uppercase border-b border-slate-800"
            >
              <th class="pb-3 px-2">Timestamp</th>
              <th class="pb-3 px-2">Unit</th>
              <th class="pb-3 px-2">Detection</th>
              <th class="pb-3 px-2">Confidence</th>
            </tr>
          </thead>
          <tbody id="log-table" class="text-sm"></tbody>
        </table>
      </div>
    </div>

    <script>
      const finishOverlay = document.getElementById("finish-overlay");

      async function update() {
        try {
          const res = await fetch("/live_status");
          if (!res.ok) return;

          const data = await res.json();
          console.log("Current Status:", data.status);

          // 1. Check for Finish
          if (data.status === "FINISHED") {
            finishOverlay.style.display = "flex";
            return;
          }

          // 2. THIS WAS MISSING: Send the data to handleEvent to show images
          if (data.last_detection) {
            handleEvent(data.status, data.last_detection);
          }

          // 3. Update the logs
          const logRes = await fetch("/detections");
          const logs = await logRes.json();
          const tbody = document.getElementById("log-table");
          tbody.innerHTML = logs
            .slice(0, 6)
            .map(
              (l) => `
                <tr class="border-b border-slate-800/50">
                    <td class="py-3 px-2 font-mono text-xs">${new Date(l.timestamp).toLocaleTimeString()}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-0.5 rounded text-[10px] ${l.source === "drone" ? "bg-blue-900 text-blue-200" : "bg-red-900 text-red-200"}">
                            ${l.source.toUpperCase()}
                        </span>
                    </td>
                    <td class="py-3 px-2 font-bold">${l.insect}</td>
                    <td class="py-3 px-2 text-green-400">${(l.confidence * 100).toFixed(1)}%</td>
                </tr>
            `,
            )
            .join("");
        } catch (e) {
          console.error("Update error:", e);
        }
      }

      function handleEvent(status, det) {
        if (!det || !det.image) return;

        const isDrone = status.startsWith("AERIAL");
        const panel = isDrone
          ? document.getElementById("drone-card")
          : document.getElementById("tank-card");
        const img = isDrone
          ? document.getElementById("drone-img")
          : document.getElementById("tank-img");
        const idle = isDrone
          ? document.getElementById("drone-idle")
          : document.getElementById("tank-idle");
        const scanLine = isDrone
          ? document.getElementById("drone-scan")
          : document.getElementById("tank-scan");
        const tag = document.getElementById(isDrone ? "drone-tag" : "tank-tag");

        // UI Focus logic
        document.getElementById("drone-card").classList.add("opacity-40");
        document.getElementById("tank-card").classList.add("opacity-40");
        panel.classList.remove("opacity-40");

        // Update Image
        img.src = "data:image/jpeg;base64," + det.image;
        img.classList.remove("hidden");
        idle.classList.add("hidden");

        // Status Tag Logic
        tag.innerText = status.split("_")[1];

        if (status.includes("SCANNING")) {
          scanLine.style.display = "block";
          tag.className =
            "px-3 py-1 rounded text-xs font-bold bg-yellow-600 text-white animate-pulse";
        } else {
          scanLine.style.display = "none";
          tag.className = `px-3 py-1 rounded text-xs font-bold ${status.includes("CLEAN") ? "bg-green-600" : "bg-blue-600"} text-white`;

          // Update Class and Confidence text
          const classEl = document.getElementById(
            isDrone ? "drone-class" : "tank-class",
          );
          const confEl = document.getElementById(
            isDrone ? "drone-conf" : "tank-conf",
          );

          if (det.class && det.class !== "None") {
            classEl.innerText = det.class.toUpperCase();
            confEl.innerText = (det.confidence * 100).toFixed(1) + "%";
          } else {
            classEl.innerText = "CLEAR";
            confEl.innerText = "0%";
          }
        }
      }

      // Start the heartbeat
      setInterval(update, 1000);
    </script>
  </body>
</html>
